
{% extends 'base.html' %}

{% block title %}Check Register - AIVIIZN{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2563eb;
        --secondary-color: #64748b;
        --success-color: #059669;
        --warning-color: #d97706;
        --danger-color: #dc2626;
        --light-bg: #f8fafc;
        --dark-text: #1e293b;
        --border-color: #e2e8f0;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
        --ag-header-font-size: 13px;
        --ag-font-size: 13px;
    }

    .report-container {
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        margin: 20px 0;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .report-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--dark-text);
        margin: 0;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .toggle-description {
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }

    .toggle-description:hover {
        opacity: 1;
    }

    .control-panel-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), #3b82f6);
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, var(--primary-color));
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
        background: #f1f5f9;
        color: var(--secondary-color);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: #e2e8f0;
        color: var(--dark-text);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .search-filter .form-control {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 8px 12px;
        transition: all 0.2s ease;
    }

    .search-filter .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
    }

    .dropdown-menu {
        border-radius: 8px;
        border: none;
        box-shadow: var(--shadow-lg);
        padding: 8px 0;
        margin-top: 4px;
    }

    .dropdown-item {
        padding: 10px 16px;
        font-size: 14px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dropdown-item:hover {
        background: var(--light-bg);
        color: var(--primary-color);
    }

    .report-description-container {
        background: var(--light-bg);
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        border-left: 4px solid var(--primary-color);
    }

    .report-description div {
        margin-bottom: 8px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .report-description strong {
        color: var(--dark-text);
        min-width: 140px;
        font-weight: 600;
    }

    .ag-theme-custom {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .ag-root-wrapper {
        border-radius: 8px;
        overflow: hidden;
    }

    .ag-header {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-bottom: 2px solid var(--border-color);
    }

    .ag-header-cell {
        border-right: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--dark-text);
    }

    .ag-header-cell:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .ag-row {
        transition: background-color 0.2s ease;
    }

    .ag-row:hover {
        background: rgba(37, 99, 235, 0.02);
    }

    .ag-row-even {
        background: #fafbfc;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .ai-enhanced {
        position: relative;
        overflow: hidden;
    }

    .ai-enhanced::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    .report-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin: 20px 0;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--primary-color);
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: var(--secondary-color);
        margin: 0;
    }

    @media (max-width: 768px) {
        .control-panel-container {
            flex-direction: column;
            align-items: stretch;
        }
        
        .btn {
            justify-content: center;
        }

        .report-description-container {
            margin-left: 0;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div id="report-container" class="report-container fade-in">
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        
        <div class="report" style="display: flex; flex-direction: column;">
            <div class="report_headers pb-2 pt-1 mb-4">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 16px;">
                    <div class="report-title-container no_selection">
                        <div class="report-title js-report-title">Check Register</div>
                        <div class="toggle-description pt-2">
                            <div class="toggle-description-text u-mobile-hidden" role="button" tabindex="0" onclick="toggleDescription()">
                                <span id="toggleText">Hide Details</span> 
                                <i class="fa fa-angle-down" id="toggleIcon"></i>
                            </div>
                            <span class="toggle-description-icon fa fa-info-circle u-desktop-hidden" role="button" tabindex="0" aria-label="Hide Details" onclick="toggleDescription()"></span>
                        </div>
                    </div>
                    
                    <div class="control-panel-container">
                        <button id="snowplow-ag-grid-view-tour" class="btn btn-secondary" onclick="startTour()">
                            <i class="fa fa-play-circle"></i>
                            View Tour
                        </button>
                        
                        <div class="d-inline-block search-filter" style="max-height: 35px;">
                            <div class="form-group row mb-3">
                                <div class="col-12 col-sm-12">
                                    <div class="input-group">
                                        <input placeholder="Search Report" type="text" class="h-100 form-control" id="searchInput" onkeyup="performSearch()">
                                        <button type="button" class="btn btn-secondary" onclick="searchPrevious()">
                                            <i aria-label="Search-previous" class="fa fa-chevron-up"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="searchNext()">
                                            <i aria-label="Search-next" class="fa fa-chevron-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fa fa-file-pdf"></i>
                                Print to PDF
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="printToPDF('landscape')">
                                    <i class="fa-regular fa-file me-2"></i>Landscape
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="printToPDF('portrait')">
                                    <i class="fa-regular fa-file me-2"></i>Portrait
                                </a></li>
                            </ul>
                        </div>
                        
                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fa fa-cog"></i>
                                Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="saveLayout()">
                                    <i class="fa-regular fa-files me-2"></i>Save Layout
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="emailReport()">
                                    <i class="fa-regular fa-envelope me-2"></i>Emailâ€¦
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportExcel()">
                                    <i class="fa-regular fa-file-excel me-2"></i>Export as Excel
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCSV()">
                                    <i class="fa fa-bar-chart me-2"></i>Export as CSV
                                </a></li>
                            </ul>
                        </div>
                        
                        <button type="button" class="btn btn-secondary" onclick="refreshReport()">
                            <i class="fa-solid fa-refresh fa-fw"></i>
                            <span class="d-none d-sm-inline d-md-inline">Refresh</span>
                        </button>
                        
                        <button type="button" class="btn btn-primary" onclick="customizeReport()">
                            <i class="fa-solid fa-cogs fa-fw"></i>
                            <span class="d-none d-sm-inline d-md-inline">Customize</span>
                        </button>
                    </div>
                </div>
                
                <div class="report-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalChecks">0</div>
                        <div class="stat-label">Total Checks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAmount">$0.00</div>
                        <div class="stat-label">Total Amount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="clearedChecks">0</div>
                        <div class="stat-label">Cleared Checks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="outstandingChecks">0</div>
                        <div class="stat-label">Outstanding Checks</div>
                    </div>
                </div>
                
                <div class="js-report-description report-description-container" id="reportDescription" style="max-width: 100%;">
                    <div class="report-description">
                        <div><strong>Properties:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">Active</div>
                            </div>
                        </div>
                        <div><strong>Date Range:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;" id="dateRange">08/01/2025 to 08/22/2025</div>
                            </div>
                        </div>
                        <div><strong>Bank Accounts:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">All</div>
                            </div>
                        </div>
                        <div><strong>Payees:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">All</div>
                            </div>
                        </div>
                        <div><strong>Payment Type:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">All</div>
                            </div>
                        </div>
                        <div><strong>Include Voided Checks:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">No</div>
                            </div>
                        </div>
                        <div><strong>Exclude Cleared Checks:</strong> 
                            <div class="d-inline-flex flex-column align-items-start mw-100">
                                <div style="display: -webkit-box; max-height: calc(3em); overflow: hidden; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">No</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="checkRegisterTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Bank Account</th>
                            <th>Check Number</th>
                            <th>Date</th>
                            <th>Payee</th>
                            <th>Memo</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Cleared Date</th>
                            <th>Property</th>
                            <th>Category</th>
                            <th>Reference</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="checkRegisterBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let checkRegisterData = [];
let filteredData = [];
let currentSearchIndex = 0;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadCheckRegisterData();
    initializeSearch();
});

// Load data from Supabase
async function loadCheckRegisterData() {
    showLoading(true);
    
    try {
        const { data, error } = await supabase
            .from('check_register')
            .select('*')
            .order('date', { ascending: false });
            
        if (error) throw error;
        
        checkRegisterData = data || [];
        filteredData = [...checkRegisterData];
        renderTable();
        updateStatistics();
    } catch (error) {
        console.error('Error loading check register data:', error);
        showNotification('Error loading data', 'error');
    } finally {
        showLoading(false);
    }
}

// Render the table
function renderTable() {
    const tbody = document.getElementById('checkRegisterBody');
    tbody.innerHTML = '';
    
    filteredData.forEach((check, index) => {
        const row = document.createElement('tr');
        row.className = 'ai-enhanced';
        row.innerHTML = `
            <td>${check.bank_account || 'N/A'}</td>
            <td><strong>${check.check_number || 'N/A'}</strong></td>
            <td>${formatDate(check.date)}</td>
            <td>${check.payee || 'N/A'}</td>
            <td>${check.memo || ''}</td>
            <td class="text-end"><strong>${formatCurrency(check.amount)}</strong></td>
            <td><span class="badge ${getStatusBadgeClass(check.status)}">${check.status || 'Pending'}</span></td>
            <td>${formatDate(check.cleared_date)}</td>
            <td>${check.property || 'N/A'}</td>
            <td>${check.category || 'N/A'}</td>
            <td>${check.reference || ''}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewCheck(${check.id})">
                        <i class="fa fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="editCheck(${check.id})">
                        <i class="fa fa-edit"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update statistics
function updateStatistics() {
    const totalChecks = filteredData.length;
    const totalAmount = filteredData.reduce((sum, check) => sum + (parseFloat(check.amount) || 0), 0);
    const clearedChecks = filteredData.filter(check => check.status === 'Cleared').length;
    const outstandingChecks = filteredData.filter(check => check.status === 'Outstanding').length;
    
    document.getElementById('totalChecks').textContent = totalChecks.toLocaleString();
    document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('clearedChecks').textContent = clearedChecks.toLocaleString();
    document.getElementById('outstandingChecks').textContent = outstandingChecks.toLocaleString();
}

// Search functionality
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    if (!searchTerm) {
        filteredData = [...checkRegisterData];
    } else {
        filteredData = checkRegisterData.filter(check => 
            (check.check_number || '').toString().toLowerCase().includes(searchTerm) ||
            (check.payee || '').toLowerCase().includes(searchTerm) ||
            (check.memo || '').toLowerCase().includes(searchTerm) ||
            (check.bank_account || '').toLowerCase().includes(searchTerm) ||
            (check.property || '').toLowerCase().includes(searchTerm) ||
            (check.category || '').toLowerCase().includes(searchTerm)
        );
    }
    
    renderTable();
    updateStatistics();
    currentSearchIndex = 0;
}

function searchNext() {
    // Implement search navigation
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (searchTerm && filteredData.length > 0) {
        currentSearchIndex = (currentSearchIndex + 1) % filteredData.length;
        highlightSearchResult();
    }
}

function searchPrevious() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (searchTerm && filteredData.length > 0) {
        currentSearchIndex = currentSearchIndex === 0 ? filteredData.length - 1 : currentSearchIndex - 1;
        highlightSearchResult();
    }
}

function highlightSearchResult() {
    const rows = document.querySelectorAll('#checkRegisterBody tr');
    rows.forEach((row, index) => {
        row.classList.toggle('table-warning', index === currentSearchIndex);
    });
    
    if (rows[currentSearchIndex]) {
        rows[currentSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Toggle description visibility
function toggleDescription() {
    const description = document.getElementById('reportDescription');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (description.style.display === 'none') {
        description.style.display = 'block';
        toggleText.textContent = 'Hide Details';
        toggleIcon.className = 'fa fa-angle-down';
    } else {
        description.style.display = 'none';
        toggleText.textContent = 'Show Details';
        toggleIcon.className = 'fa fa-angle-right';
    }
}

// Action functions
function startTour() {
    showNotification('Tour started! This would guide you through the check register features.', 'info');
}

function refreshReport() {
    loadCheckRegisterData();
    showNotification('Report refreshed successfully', 'success');
}

function customizeReport() {
    // Open customization modal
    showNotification('Customization panel would open here', 'info');
}

function saveLayout() {
    localStorage.setItem('checkRegisterLayout', JSON.stringify({
        columns: 'current-layout',
        filters: 'current-filters'
    }));
    showNotification('Layout saved successfully', 'success');
}

function emailReport() {
    showNotification('Email dialog would open here', 'info');
}

function exportExcel() {
    // Implement Excel export
    const csvContent = convertToCSV(filteredData);
    downloadFile(csvContent, 'check-register.csv', 'text/csv');
    showNotification('Report exported as Excel', 'success');
}

function exportCSV() {
    const csvContent = convertToCSV(filteredData);
    downloadFile(csvContent, 'check-register.csv', 'text/csv');
    showNotification('Report exported as CSV', 'success');
}

function printToPDF(orientation) {
    window.print();
    showNotification(`Printing in ${orientation} mode`, 'info');
}

function viewCheck(checkId) {
    window.location.href = `/checks/${checkId}`;
}

function editCheck(checkId) {
    window.location.href = `/checks/${checkId}/edit`;
}

// Utility functions
function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString();
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount || 0);
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'Cleared': return 'bg-success';
        case 'Outstanding': return 'bg-warning text-dark';
        case 'Voided': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function convertToCSV(data) {
    if (!data.length) return '';
    
    const headers = Object.keys(data[0]).join(',');
    const rows = data.map(row => 
        Object.values(row).map(value => 
            typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value
        ).join(',')
    );
    
    return [headers, ...rows].join('\n');
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
}

function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    });
}

// Initialize table sorting
function initializeTableSorting() {
    const headers = document.querySelectorAll('#checkRegisterTable th');
    headers.forEach((header, index) => {
        if (index < headers.length - 1) { // Skip actions column
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => sortTable(index));
        }
    });
}

function sortTable(columnIndex) {
    const table = document.getElementById('checkRegisterTable');
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.rows);
    
    // Toggle sort direction
    const isAscending = !table.dataset.sortAsc || table.dataset.sortAsc === 'false';
    table.dataset.sortAsc = isAscending;
    
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // Try to parse as numbers for numeric columns
        const aNum = parseFloat(aValue.replace(/[$,]/g, ''));
        const bNum = parseFloat(bValue.replace(/[$,]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? aNum - bNum : bNum - aNum;
        }
        
        // String comparison
        return isAscending ? 
            aValue.localeCompare(bValue) : 
            bValue.localeCompare(aValue);
    });
    
    // Rebuild table body
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update header indicators
    updateSortIndicators(columnIndex, isAscending);
}

function updateSortIndicators(activeColumn, isAscending) {
    const headers = document.querySelectorAll('#checkRegisterTable th');
    headers.forEach((header, index) => {
        const indicator = header.querySelector('.sort-indicator');
        if (indicator) indicator.remove();
        
        if (index === activeColumn) {
            const span = document.createElement('span');
            span.className = 'sort-indicator ms-1';
            span.innerHTML = isAscending ? '<i class="fa fa-sort-up"></i>' : '<i class="fa fa-sort-down"></i>';
            header.appendChild(span);
        }
    });
}

// Initialize sorting when table is rendered
setTimeout(initializeTableSorting, 100);
</script>
{% endblock %}
